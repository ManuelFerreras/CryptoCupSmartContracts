// SPDX-License-Identifier: MIT


/**

 * CryptoCup Smart Contracts
 *
 * Developed By:
 *    - Manuel (NuMa) Ferreras
 *
 */

// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/*(((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/***,///*,@@@@/,%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/,,,,,,*#@(*%@&/,/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(*(/%@@(,*@#&@@@@/&@@@@@@@@@@@@@,,/,.*,.*,,,/(/*#/*,/*,,,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/*&&&@@&,(#/%%(&@@#&@@@@@@@@@@,//(***///(&#&#*,.,&@@&(,/((@(,./@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@##.#%@@%%(,@,,/#@&@@@@@@@@@@*#,/@@@@%/*/(@/*/@@%*,.,@@@@@#@@,/&/,,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#@&*(/,,,,/(#@@@@@@@@#*(@@@&**/@@/**%&&&(*(%%#,,,%%%%@@@&@*(/,,,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#/**,,,*@*@@@@@(*@@%%%%%%%%%%&&@@@@@@@*,%&*,,&&&%%%@@@@./@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@*#/**,*/@(@&&&&&&&&&&&&&&&%%%%%&&@&@@@,.%*,.,&&%%%@@@%.*/,,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,,*,*#(#%%%##(/@@@@@@*//*#*,..//(@@@@&&&@@&&&&&&&&&%%%%%&@@@@**%(*,&&%%%%@@@.(/,*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,,,*%@//&@@@@@@@@@@@@%%&&@@@*(*,,,,%,@@@@@@@@@&&&&&&&&%%%%%&@@@@/#@#/&&%%%%@@@../,@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,,,,*@%(#(((((////(%%%%&&&&&@@@@*(,,,..#&@@@@@@@@&&&&&&&%%%%%%%@@@#/*#.&&&%%%@@@.&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,*%,,,(@/(@@%***&&#@%%%&&&&&&&&&&@@@/(,..,%#@@@@@@@&&&&&&&%%%%%%%&@@@(*@**&&&%%%@@#*#*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(,*#**@/(%@%/@*/@&&@@&%%%&&&&&&&&&&&&&&@@#&*,.*%@@@@&&&&&&&&&&%%%%%%&@@@@@&/,..&&%%%@@&&(#/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&,.(/*@%@,../@**&&@@@@@&%&&&&&&&&&&&&&&&&&&@@%#/.,#&@@&&&&&&&&&&&%%%%%&&@@@&,,,,,#&&%%@@@@%#/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,*(/*@#@@@,,,*@/,@@@@@@&&&&&&&&&&&&&&&&&&&&&&@@@,(/%*@@@@&&&&&&&&&&&&&&&&@@@@#(///@@%*%@@@/*(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*(/,@@@@@%*,,/*(..@@@@@&&&&&%%&&&&&&&&&&&&&&@@@@@#,,,,,,@@@&&&&&&&&&&@@@@#(/*%@/*#*,%#*@@.*#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@,,*#*@@@@@%%&&,..*&(*,@@@@&&&&&&&&&&&&&&&&&&&&@@@&,/((***/*@@@@@@&&&&&&@@*,*&@@/*@,,&@,*&**#((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@/#*.@@@@@%%&&&&%..*(##.%@@@@&&&&&&&&&&&&&&&&&&&@#(####(/(@%/,##//&@&&&&&@@@#/@@./*#%&&@@&*@*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@,,*%,,%@@@&@%%%&&&&&*/(@#.@@@@@@@&&&&&&&&&&&&@@@@@@@@@*(/@,(@@@@.@@@@&.,@@@@@@@@/%&*@(***#&*%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,,/(/,/@@@@&@@%%%&&&&,**/#@@@@@@@&&&&&&&&&@%,(/(&@#,,#*#(*@@@(@@@@@%,@(/.////@&/*,/(%%&%%##%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,./@/(*.@@@&&@%%&&#..*/((#@@@@@@@@&&&&&&&&%.(@@@@,*,(@.&@@@@@&(&@@#(*..(%((((#(#(((#%/(@(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*#,&@@@&@%%&&&#*/(#@*%%%*..@@&*,/@&&&@@@@@(.@,,@@@@//.,(#*,,....,,**/(*%%&#**#%(/%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,//*@@@@@&@%(//*@(,@%(@@#%@@@&@#*#&@@@@(.@@/*.,(%((//*,...((..**/////,%&%**,*/,*//(#(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/##%%@@@@@%%(@@(**#,,@@@@@@@*@@@@@**.((((((//%&&*..,,*//,*(*(##(#(//,*(%%%&##%&@%&%#%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(%/((@%#@%.@@//.@*//*/%/*,(###((/*,,...&%#%&((((((((#(*,./%#((/***,,,,,,/%**((##%%/%&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/%###@@@@/#@@%*,(####((/***/*/***,**/////((*.*%@&&%%%(#(//(/,.       ,/((#&#%(*###&&((#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@,##@%@#*(%%##(%(/*,,,//(,*,*//(#/*.*%@@%&%&%&%%%##(##(/((**, ..  ,*.*     ,  #((,#,**%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(#%%%###(/#%%**.//*/((#/,,(@@@@@@@@@@%#%%%%%%%#(%#####(/*/... /.(// .  .     .##,.,&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&#%*(.*,,,%%#(/*,(@@@@@@@@@@@@@@@&%#@(@@@@(/#,.@@@/. ,//,*.*%&%%%#(* *  , , ,/,# *#%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&,##&**/*,/%@@@&&&&@@@@@@@@@@@@@%,%@@@@@#%@@@@@@@****(,, .,,(&/@&&%#((.*.   *(//%*./&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(/(@@@@@@@&%#&#%@&@@@@@@@@@@@(@@@@@@@@@@@&@@@@@&%@&&&&&#,(.#&@#&,(%(%(/(/*/(%%%%%,.%%#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@&&&&@@&&#&%####&@@@@@@@&@@(&%/*@@@@@@@@@@%@@@/@@@&%&@#@@#,/#*&&&,&/(%(#&&&&%&&&&&.*,/&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&%%%@&(((%#%%&&&@@@@@%@(@(%/&%@@@@@@@@@@@@@@@@#@@@@@@@@@@&&@(#&&@%#@%&@@%@(&&@&&%,.(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&%%%%         %&          #@&...@@@@   @@,       ..@@        *@&         @&@&#%,,.@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@@@#(%%*   &@%@@@@@   @@@&   &%@.. ,*  *@@@,  (@@@...*@@@@   &@@&@,  @@@@@   @@&&%,,,%*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@&%&&(/%#*   (/*((#%&         *%%@@@    @@@@@,        .@@@@@   &&%%%,  @@&@@/  (@@@**&# %/%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#&&&@%%*(%//   #((#(%&&   @@,   @&%@@@,  #@@@@@,  (@@@@@@@@#@@   &#&@%,  #@@@@   @@@/*%&%((*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#@&(%%&#&&%,(#,*         ##   #%&@   #&@@@,  #@@@@@,  (@@@@@@@@@@@   #(#%##%,      &@@@&(@((#%,%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&@@&@@@@@@@@@@@@@@@@@@@@@@@@@%%###(#####%%#(((#%/%@@&#%%/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@&#&%%&(%**%(//(((/. ,,***,,.,///((      @@/  /@@@@   @@@        %##//((((#####((///&%&@@#%%#/%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#&%%&&&(,&,(//.*./**/(/*****/#,   &%@%@&@*  /@@@@   @@@   @@@*   ##(((((#((((////*&#%#%&%%/@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#*%%&&&.,,***.* .*////(((((##   #(&/@(&@/  /&@@&   @@@   @&&#   %##(#((*. ./((///(&.&&&%%@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#&&&(.,//*,/,*///((//(((##%   &%%&@@%%*  *@@&@   &&&   &    (%%%%##(/...*/#(//&/&%.//(&@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/,( * .**///((////*/(/(#(%        @@@         ,@@&   &%###########(///((////&#/,@%/(&@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#& ./#&&&@.,*((((((,##*(#**/@@@@@@@@@@@@@@%@@@@%@@@@@&@##((((((#####((((((///@#(%%&((@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#(/##&&&&@@& .@/((((,*/(&/@@@@@@@@@@@@@@#@&%@@@@%@&@@@@(#((((((((((((((((/***#%##/%(@@@#&@@@@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@/@,%&&&&&&&%#/%.#/**@%@@@@@@@@@@@@@@@&&@@@@@@@@@@@@@@@(&((((((((((((///*(#&/,&%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@/@#@%%&&&&&&&@@#//,(/&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%((((((////@@(((%&%%*/#@(@@@@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@%%&&&&&&@&@@@@&/#%&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((/@@(#/&@#@%&&&%(**#@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&&@(%&&&@&@&&@&@&(,@%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#@%#@@@@@@@&%@&&&%#/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#(#.#%&&&&@@@@@***&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(#%(@@@@@&&@&@&&%%#(@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#//(&&@&&&&&#(#/.@@@@@&@@@@@@@@@@@@@@@@@@@@&/@&@@@@@&@@&&&&%%&#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*(##%&%&%*&%@&,&%%&@@@%@@@@@@@@@@@@@#@/(%@@@@@@&&&&%#%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&@@@/%#%,*//(#####(###(((//*,,/@%(#@%##@&&&&%%%%&@%@&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#,,/(((((###############(((@#&&&&&##@@@@@@@@@@@&&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(#@@&&@@@@@@(#####(##(#((#@(%##&@@@@@@@@@@&@&@@/@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(@%@@@@@@@@@@@@@@@@@@&@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


pragma solidity ^0.8.4;

import './ERC721A.sol';
import './Ownable.sol';

contract CryptoCupsTickets is ERC721A, Ownable {

    uint public totalBuyers = 0;
    uint private _baseReferralCode = 100000;

    mapping (address => uint) public referralCodes;
    mapping (uint => address) public referralAddresses;

    uint public referedDiscount = 1;
    uint public referralFee = 1;

    // Ticket Type
    mapping (uint => string) public ticketType; 
    mapping (uint => uint) public ticketBatch;

    uint public basicPrice; 
    uint public boostPrice; 

    uint8 public currentBatch = 0; 
    uint public currentBatchDeadline = 0;


    // Ticket Types
    string[] private ticketTypes = ["Basic", "Boost"]; 

    // Different Currencies Accepted
    address[] public currencies = [
        0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063, // DAI Matic
        0xA8D394fE7380b8cE6145d5f85E6aC22d4E91ACDe, // BUSD Matic
        0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174, // USDC Matic
        0xc2132D05D31c914a87C6611C10748AEb04B58e8F // USDT Matic
    ];

    // Owners Fees Collector
    address ownersFeesCollector;

    // Owners Fees
    uint ownersFees = 5;


    // Constructor
    constructor(string memory name_, string memory symbol_) ERC721A (name_, symbol_) {}


    // Events
    event currencyAdded(address);
    event currencyRemoved(uint);
    event batchChanged(uint, uint);
    event newReferralValues(uint, uint);
    event newFeesCollector(address);
    event newFees(uint);


    // Functions
    function mint(uint _amount, uint _currency, uint _type, uint _referralCode) public onlyOngoingBatch checkNotSelfReferral(_referralCode) {
        // Check if Params Are Correct
        require(_amount > 0, "Invalid Amount.");
        require(_currency >= 0 && _currency < currencies.length, "Invalid Currency.");
        require(_type == 0 || _type == 1, "Invalid Type.");

        bool _discount = referralAddresses[_referralCode] != address(0)? true : false;

        uint _unitPrice = (_type == 0? basicPrice : boostPrice) - (_discount? referedDiscount : 0);

        // Checks msg.sender has enough balance.
        IERC20Metadata _selectedCurrency = IERC20Metadata(currencies[_currency]);
        uint _totalPriceAmount = _amount * _unitPrice * _selectedCurrency.decimals();
        require(_selectedCurrency.balanceOf(msg.sender) >= _unitPrice, "Not Enough Balance to Pay.");
        require(_selectedCurrency.allowance(msg.sender, address(this)) >= _unitPrice, "Not Enough Allowance to Pay.");

        uint _totalReferralAmount = _discount? _amount * referralFee *  _selectedCurrency.decimals() : 0;
        uint _totalOwnersFees = _discount? ownersFees *  _selectedCurrency.decimals() : ownersFees *  _selectedCurrency.decimals() * 2;

        // Pay for the ticket.
        _selectedCurrency.transferFrom(msg.sender, address(this), _totalPriceAmount - _totalReferralAmount - _totalOwnersFees);
        _selectedCurrency.transferFrom(msg.sender, ownersFeesCollector, _totalOwnersFees);
        _selectedCurrency.transferFrom(msg.sender, referralAddresses[_referralCode], _totalReferralAmount);
        
        if(referralCodes[msg.sender] == 0) {
            totalBuyers++;
            referralCodes[msg.sender] = _baseReferralCode + totalBuyers;
            referralAddresses[_baseReferralCode + totalBuyers] = msg.sender;
        }

        // Mint the Tickets!
        _mint(msg.sender, _amount, _type);
    }   


    /**
     * @dev Mints `quantity` tokens and transfers them to `to`.
     *
     * Requirements:
     *
     * - `to` cannot be the zero address.
     * - `quantity` must be greater than 0.
     *
     * Emits a {Transfer} event.
     */
    function _mint(address to, uint256 quantity, uint256 _type) internal {
        uint256 startTokenId = _currentIndex;
        if (to == address(0)) revert MintToZeroAddress();
        if (quantity == 0) revert MintZeroQuantity();

        _beforeTokenTransfers(address(0), to, startTokenId, quantity);

        // Overflows are incredibly unrealistic.
        // balance or numberMinted overflow if current value of either + quantity > 1.8e19 (2**64) - 1
        // updatedIndex overflows if _currentIndex + quantity > 1.2e77 (2**256) - 1
        unchecked {
            _addressData[to].balance += uint64(quantity);
            _addressData[to].numberMinted += uint64(quantity);

            _ownerships[startTokenId].addr = to;
            _ownerships[startTokenId].startTimestamp = uint64(block.timestamp);

            uint256 updatedIndex = startTokenId;
            uint256 end = updatedIndex + quantity;

            do {
                ticketType[updatedIndex] = ticketTypes[_type];
                ticketBatch[updatedIndex] = currentBatch;
                emit Transfer(address(0), to, updatedIndex++);
            } while (updatedIndex < end);

            _currentIndex = updatedIndex;
        }
        _afterTokenTransfers(address(0), to, startTokenId, quantity);
    }


    function addCurrency(address _newCurrency) public onlyOwner {
        currencies.push(_newCurrency);
        emit currencyAdded(_newCurrency);
    }


    function removeCurrency(uint _index) public onlyOwner {
        require(_index >= 0 && _index < currencies.length, "Invalid Currency.");

        currencies[_index] = currencies[currencies.length - 1];
        currencies.pop();
        emit currencyRemoved(_index);
    }


    function getCurrencies() public view returns (address[] memory) {
        return currencies;
    }


    function tokenURI(uint256 tokenId) public view virtual override returns (string memory) {
        if (!_exists(tokenId)) revert URIQueryForNonexistentToken();

        string memory baseURI = _baseURI();
        return bytes(baseURI).length != 0 ? string(abi.encodePacked(baseURI, ticketType[tokenId], ".json")) : '';
    }


    function nextBatch(uint deadline, uint _basicPrice, uint _boostPrice) public onlyOwner {
        require(_basicPrice >= 0, "Invalid Price");
        require(_boostPrice >= 0, "Invalid Price");

        basicPrice = _basicPrice;
        boostPrice = _boostPrice;

        currentBatch++;
        currentBatchDeadline = deadline;
        emit batchChanged(currentBatch, currentBatchDeadline);
    }


    function setReferralValues(uint _referralFee, uint _referedDiscount) public onlyOwner {
        require(_referralFee >= 0, "Invalid Price");
        require(_referedDiscount >= 0, "Invalid Price");

        referralFee = _referralFee;
        referedDiscount = _referedDiscount;

        emit newReferralValues(referralFee, referedDiscount);
    }


    function setOwnersFeesCollector(address _newCollector) public onlyOwner {
        require(_newCollector != ownersFeesCollector, "Already set to that collector.");
        ownersFeesCollector = _newCollector;
        emit newFeesCollector(_newCollector);
    }

    
    function setOwnersFees(uint _newFee) public onlyOwner {
        require(ownersFees != _newFee, "Already set to that fee.");
        ownersFees = _newFee;
        emit newFees(_newFee);
    }


    function checkIfValidReferralCode(uint _referralCode) public view returns(bool) {
        return referralAddresses[_referralCode] != address(0)? true : false;
    }

    function checkIfValidReferrer(address _referralAddress) public view returns(bool) {
        return referralCodes[_referralAddress] != 0? true : false;
    }


    // Modifiers
    modifier onlyOngoingBatch() {
        require(block.timestamp < currentBatchDeadline, "Batch has already finished.");
        _;
    }

    modifier checkNotSelfReferral(uint ref) {
        require(msg.sender != referralAddresses[ref], "You can not refer yourself.");
        _; 
    }

}